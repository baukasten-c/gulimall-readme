# 新增商品

1、示例数据

```json
{
	"spuName": "华为 HUAWEI Mate 30 Pro", 
	"spuDescription": "华为 HUAWEI Mate 30 Pro",
	"catalogId": 225,
	"brandId": 1,
	"weight": 0.198,
	"publishStatus": 0,
	"decript": ["https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/2fca0fbd-0e86-4c27-856a-be5067fa511d_73366cc235d68202.jpg"],
	"images": ["https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/4885bd1b-4751-4feb-8781-2316362e66f9_28f296629cca865e.jpg", "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/200ed4b8-24d4-46a5-862c-13b0f969f489_919c850652e98031.jpg", "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/1a54ef88-5084-4483-87bf-e38b178d572f_b5c6b23d01dcdf81.jpg", "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/452909d4-8197-4cd2-86d8-119fe1e6c28b_8bf441260bffa42f.jpg"],
	"bounds": {
		"buyBounds": 500,
		"growBounds": 500
	},
	"baseAttrs": [{
		"attrId": 5,
		"attrValues": "2019;2020",
		"showDesc": 1
	}, {
		"attrId": 4,
		"attrValues": "LIO-AL00",
		"showDesc": 1
	}],
	"skus": [{
		"attr": [{
			"attrId": 11,
			"attrName": "颜色",
			"attrValue": "黑色"
		}, {
			"attrId": 16,
			"attrName": "内存",
			"attrValue": "4G"
		}],
		"skuName": "华为 HUAWEI Mate 30 Pro 黑色 4G",
		"price": "5799",
		"skuTitle": "华为 HUAWEI Mate 30 Pro 黑色 4G 麒麟990芯片",
		"skuSubtitle": "现货抢购，12期免息",
		"images": [{
			"imgUrl": "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/4885bd1b-4751-4feb-8781-2316362e66f9_28f296629cca865e.jpg",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/452909d4-8197-4cd2-86d8-119fe1e6c28b_8bf441260bffa42f.jpg",
			"defaultImg": 1
		}],
		"descar": ["黑色", "4G"],
		"fullCount": 3,
		"discount": 0.98,
		"countStatus": 1,
		"fullPrice": 10000,
		"reducePrice": 100,
		"priceStatus": 1,
		"memberPrice": [{
			"id": 2,
			"name": "铜牌会员",
			"price": 5259
		}, {
			"id": 3,
			"name": "银牌会员",
			"price": 5219
		}]
	}, {
		"attr": [{
			"attrId": 11,
			"attrName": "颜色",
			"attrValue": "黑色"
		}, {
			"attrId": 16,
			"attrName": "内存",
			"attrValue": "8G"
		}],
		"skuName": "华为 HUAWEI Mate 30 Pro 黑色 8G",
		"price": "6299",
		"skuTitle": "华为 HUAWEI Mate 30 Pro 黑色 8G 麒麟990芯片",
		"skuSubtitle": "现货抢购，12期免息",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["黑色", "8G"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 2,
			"name": "铜牌会员",
			"price": 0
		}, {
			"id": 3,
			"name": "银牌会员",
			"price": 0
		}]
	}, {
		"attr": [{
			"attrId": 11,
			"attrName": "颜色",
			"attrValue": "蓝色"
		}, {
			"attrId": 16,
			"attrName": "内存",
			"attrValue": "4G"
		}],
		"skuName": "华为 HUAWEI Mate 30 Pro 蓝色 4G",
		"price": "5799",
		"skuTitle": "华为 HUAWEI Mate 30 Pro 蓝色 4G 麒麟990芯片",
		"skuSubtitle": "现货抢购，12期免息",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["蓝色", "4G"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 2,
			"name": "铜牌会员",
			"price": 0
		}, {
			"id": 3,
			"name": "银牌会员",
			"price": 0
		}]
	}, {
		"attr": [{
			"attrId": 11,
			"attrName": "颜色",
			"attrValue": "蓝色"
		}, {
			"attrId": 16,
			"attrName": "内存",
			"attrValue": "8G"
		}],
		"skuName": "华为 HUAWEI Mate 30 Pro 蓝色 8G",
		"price": "6299",
		"skuTitle": "华为 HUAWEI Mate 30 Pro 蓝色 8G 麒麟990芯片",
		"skuSubtitle": "现货抢购，12期免息",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "https://guli-mall--oss.oss-cn-beijing.aliyuncs.com/2023-08-30/1a54ef88-5084-4483-87bf-e38b178d572f_b5c6b23d01dcdf81.jpg",
			"defaultImg": 1
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["蓝色", "8G"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 2,
			"name": "铜牌会员",
			"price": 0
		}, {
			"id": 3,
			"name": "银牌会员",
			"price": 0
		}]
	}]
}
```

2、编写新增商品接口，保存 spu 信息

2-1、在 pms_spu_info 表中保存 spu 基本信息(spuName、spuDescription、catalogId、brandId、weight、publishStatus)

```java
SpuInfoEntity spuInfoEntity = new SpuInfoEntity();
BeanUtils.copyProperties(spuSaveVo, spuInfoEntity);
this.save(spuInfoEntity);
```

生成的主键 id 会自动封装到 spuInfoEntity 这个实体对象中，同时 create_time 和 update_time 会自动填充

2-2、在 pms_spu_info_desc 表中保存 spu 商品介绍(decript)

```java
List<String> decripts = spuSaveVo.getDecript();
SpuInfoDescEntity spuInfoDescEntity = new SpuInfoDescEntity();
spuInfoDescEntity.setSpuId(spuInfoEntity.getId());
spuInfoDescEntity.setDecript(String.join(",", decripts));
spuInfoDescService.save(spuInfoDescEntity);
```

2-3、在 pms_spu_images 表中保存 spu 商品图集(images)

```java
@Override
@Transactional
public void saveSpuInfo(SpuSaveVo spuSaveVo) {
    List<String> images = spuSaveVo.getImages();
    spuImagesService.saveSpuInfoImages(spuInfoEntity.getId(), images);
}

@Override
public void saveSpuInfoImages(Long id, List<String> images) {
    if(images == null || images.size() == 0){
        return;
    }
    List<SpuImagesEntity> spuImagesEntities = images.stream().map(img -> {
        SpuImagesEntity spuImagesEntity = new SpuImagesEntity();
        spuImagesEntity.setSpuId(id);
        spuImagesEntity.setImgUrl(img);
        return spuImagesEntity;
    }).collect(Collectors.toList());
    this.saveBatch(spuImagesEntities);
}
```

2-4、在 sms_spu_bounds 表中保存 spu 积分信息(bounds)

```java
Bounds bounds = spuSaveVo.getBounds();
SpuBoundTo spuBoundTo = new SpuBoundTo();
BeanUtils.copyProperties(bounds, spuBoundTo);
spuBoundTo.setSpuId(spuInfoEntity.getId());
R r = couponFeignService.saveSpuBounds(spuBoundTo);
if(r.getCode() != 0){
    log.error("远程保存spu积分信息失败");
}
```

2-5、在 pms_product_attr_value 表中保存 spu 规格参数(baseAttrs)

```java
List<BaseAttrs> baseAttrs = spuSaveVo.getBaseAttrs();
List<ProductAttrValueEntity> productAttrValueEntities = baseAttrs.stream().map(attr -> {
    ProductAttrValueEntity productAttrValueEntity = new ProductAttrValueEntity();
    productAttrValueEntity.setSpuId(spuInfoEntity.getId());
    productAttrValueEntity.setAttrId(attr.getAttrId());
    AttrEntity attrEntity = attrService.getById(attr.getAttrId());
    productAttrValueEntity.setAttrName(attrEntity.getAttrName());
    productAttrValueEntity.setAttrValue(attr.getAttrValues());
    productAttrValueEntity.setQuickShow(attr.getShowDesc());
    return productAttrValueEntity;
}).collect(Collectors.toList());
productAttrValueService.saveBatch(productAttrValueEntities);
```

3、编写新增商品接口，保存 sku 信息

3-1、获取当前 spu 的 sku 数据，数据不为空，再进行后续操作

```java
List<Skus> skus = spuSaveVo.getSkus();
if(skus != null && skus.size() > 0){
    skus.forEach(sku -> {...});
}
```

.forEach() 用于对集合中的元素执行某种操作，而 .stream().map() 用于通过对集合中的元素应用某种操作来生成一个新的集合

3-2、在 pms_sku_info 表中保存 sku 基本信息(skuName、price、skuTitle、skuSubtitle)

```java
SkuInfoEntity skuInfoEntity = new SkuInfoEntity();
BeanUtils.copyProperties(sku, skuInfoEntity);
skuInfoEntity.setSpuId(spuInfoEntity.getId());
skuInfoEntity.setCatalogId(spuInfoEntity.getCatalogId());
skuInfoEntity.setBrandId(spuInfoEntity.getBrandId());
List<String> imgUrls = sku.getImages().stream()
        .filter(img -> img.getDefaultImg() == 1)
        .map(Images::getImgUrl)
        .collect(Collectors.toList());
skuInfoEntity.setSkuDefaultImg(String.join(",", imgUrls));
skuInfoEntity.setSaleCount(0L);
skuInfoService.save(skuInfoEntity);
```

3-3、在 pms_sku_image 表中保存 sku 图集(images)

```java
Long skuId = skuInfoEntity.getSkuId();
List<SkuImagesEntity> skuImagesEntities = sku.getImages().stream()
        .filter(skuImagesEntity -> {
            return !StringUtils.isEmpty(skuImagesEntity.getImgUrl());
        }).map(img -> {
            SkuImagesEntity skuImagesEntity = new SkuImagesEntity();
            skuImagesEntity.setSkuId(skuId);
            skuImagesEntity.setImgUrl(img.getImgUrl());
            skuImagesEntity.setDefaultImg(img.getDefaultImg());
            return skuImagesEntity;
        }).collect(Collectors.toList());
skuImagesService.saveBatch(skuImagesEntities);
```

3-4、在 pms_sku_sale_attr_value 表中保存 sku 销售属性(attr)

```java
List<Attr> attrs = sku.getAttr();
List<SkuSaleAttrValueEntity> skuSaleAttrValueEntities = attrs.stream().map(attr -> {
    SkuSaleAttrValueEntity skuSaleAttrValueEntity = new SkuSaleAttrValueEntity();
    BeanUtils.copyProperties(attr, skuSaleAttrValueEntity);
    skuSaleAttrValueEntity.setSkuId(skuId);
    return skuSaleAttrValueEntity;
}).collect(Collectors.toList());
skuSaleAttrValueService.saveBatch(skuSaleAttrValueEntities);
```

4、编写新增商品接口，保存 sku 优惠信息

4-1、在 sms_sku_ladder 表中保存 sku 折扣信息(fullCount、discount、price)

```java
SkuLadderEntity skuLadderEntity = new SkuLadderEntity();
BeanUtils.copyProperties(skuReductionTo, skuLadderEntity);
skuLadderEntity.setAddOther(skuReductionTo.getCountStatus());
if(skuReductionTo.getFullCount() > 0){
    skuLadderService.save(skuLadderEntity);
}
```

4-2、在 sms_sku_full_reduction 表中保存 sku 减免信息(fullPrice、reducePrice)

```java
SkuFullReductionEntity skuFullReductionEntity = new SkuFullReductionEntity();
BeanUtils.copyProperties(skuReductionTo, skuFullReductionEntity);
skuFullReductionEntity.setAddOther(skuReductionTo.getPriceStatus());
if(skuFullReductionEntity.getFullPrice().compareTo(BigDecimal.valueOf(0)) == 1){
    this.save(skuFullReductionEntity);
}
```

4-3、在 sms_member_price 表中保存 sku 会员价信息(memberPrice)

```java
List<MemberPrice> memberPrices = skuReductionTo.getMemberPrice();
List<MemberPriceEntity> memberPriceEntities = memberPrices.stream()
        .filter(memberPrice -> memberPrice.getPrice().compareTo(BigDecimal.valueOf(0)) == 1)
        .map(memberPrice -> {
            MemberPriceEntity priceEntity = new MemberPriceEntity();
            priceEntity.setSkuId(skuReductionTo.getSkuId());
            priceEntity.setMemberLevelId(memberPrice.getId());
            priceEntity.setMemberLevelName(memberPrice.getName());
            priceEntity.setMemberPrice(memberPrice.getPrice());
            priceEntity.setAddOther(1);
            return priceEntity;
        }).collect(Collectors.toList());
memberPriceService.saveBatch(memberPriceEntities);
```

